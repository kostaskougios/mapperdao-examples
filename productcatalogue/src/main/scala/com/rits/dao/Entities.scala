package com.rits.dao
import com.googlecode.mapperdao.Entity
import com.googlecode.mapperdao.IntId
import com.rits.model.Category
import com.googlecode.mapperdao.Persisted
import com.googlecode.mapperdao.ValuesMap
import com.rits.model.Attribute
import com.rits.model.Price
import com.rits.model.Product
import com.googlecode.mapperdao.SimpleEntity

/**
 * entity declarations for all domain classes
 *
 * @author kostantinos.kougios
 *
 * 10 Oct 2011
 */
object Entities {
	object ProductEntity extends Entity[IntId, Product](classOf[Product]) {
		val id = intAutoGeneratedPK("id", _.id)
		val title = string("title", _.title)
		val description = string("description", _.description)
		val prices = oneToMany(classOf[Price], _.prices)
		val attributes = manyToMany(classOf[Attribute], _.attributes)
		val categories = manyToMany(classOf[Category], _.categories)

		def constructor(implicit m: ValuesMap) = new Product(title, description, prices, attributes, categories, Set()) with IntId with Persisted {
			val id: Int = ProductEntity.id
		}
	}

	object CategoryEntity extends Entity[IntId, Category](classOf[Category]) {
		val id = intAutoGeneratedPK("id", _.id)
		val name = string("name", _.name)
		val category = manyToOne("parent_id", classOf[Category], _.parent.getOrElse(null))

		def constructor(implicit m: ValuesMap) = {
			val c = m(category) match {
				case cat: Category => Some(cat)
				case null => None
			}
			new Category(name, c) with Persisted with IntId {
				val id: Int = CategoryEntity.id
			}
		}
	}

	object AttributeEntity extends Entity[IntId, Attribute](classOf[Attribute]) {
		val id = intAutoGeneratedPK("id", _.id)
		val name = string("name", _.name)
		val value = string("value", _.value)
		def constructor(implicit m: ValuesMap) = new Attribute(name, value) with IntId with Persisted {
			val id: Int = AttributeEntity.id
		}
	}

	object PriceEntity extends SimpleEntity[Price](classOf[Price]) {
		val currency = string("currency", _.currency)
		val unitPrice = double("unitprice", _.unitPrice)
		val salePrice = double("saleprice", _.salePrice)
		val pks = declarePrimaryKeys(SimpleColumn("currency"))
		def constructor(implicit m: ValuesMap) = new Price(currency, unitPrice, salePrice) with Persisted
	}
}
